Ниже представлена инструкция в формате Markdown, описывающая процесс автоматизации реверта пулл-реквеста через создание новой ветки и пулл-реквеста, с использованием предоставленного Bash-скрипта. Инструкция включает описание, шаги установки, использование и примеры.


# Автоматизация реверта пулл-реквеста в Git

## Описание

Этот документ описывает процесс автоматизации реверта изменений, внесённых пулл-реквестом (PR), когда прямой реверт в основной ветке (например, `main`) запрещён, и изменения должны вноситься через новый пулл-реквест. Предоставленный Bash-скрипт `revert_pr.sh` позволяет:
- Создать новую ветку для реверта.
- Выполнить реверт мерж-коммита или всех коммитов из указанного PR.
- Создать новый пулл-реквест с реверт-изменениями.

Скрипт поддерживает два сценария:
1. Реверт мерж-коммита (если PR был вмержен с созданием мерж-коммита).
2. Реверт всех коммитов PR (если использовался squash или rebase).

## Требования

- **Git**: Установлен и настроен.
- **GitHub CLI (`gh`)**: Установлен для создания пулл-реквестов.
  - Установка: `brew install gh` (macOS/Linux) или эквивалент для вашей ОС.
  - Аутентификация: `gh auth login`.
- **Переменная окружения `GITHUB_TOKEN`**: Токен с правами на создание веток и PR.
  - Настройка: Экспортируйте токен в переменную окружения:
    ```bash
    export GITHUB_TOKEN=<your-token>
    ```
- **Репозиторий**: Укажите имя репозитория в формате `owner/repo-name` в скрипте.
- Права на push в репозиторий и создание PR.

## Установка

1. Создайте файл `revert_pr.sh` и вставьте следующий код:

   ```bash
   #!/bin/bash

   if [ -z "$1" ]; then
     echo "Ошибка: укажите хэш мерж-коммита или номер PR"
     exit 1
   fi

   INPUT=$1
   BRANCH_NAME="revert-pr-$INPUT-$(date +%s)"
   REPO="owner/repo-name"  # Замените на имя вашего репозитория
   GITHUB_TOKEN=$GITHUB_TOKEN  # Убедитесь, что переменная окружения задана

   # Создание новой ветки
   git checkout main
   git pull origin main
   git checkout -b "$BRANCH_NAME"

   # Проверка, является ли входной параметр хэшем коммита или номером PR
   if git rev-parse "$INPUT" >/dev/null 2>&1; then
     # Входной параметр - хэш мерж-коммита
     git revert -m 1 --no-edit "$INPUT"
   else
     # Входной параметр - номер PR, получаем коммиты
     COMMITS=$(gh pr view "$INPUT" --repo "$REPO" --json commits --jq '.commits[].oid' | tac)
     for COMMIT in $COMMITS; do
       git revert --no-edit "$COMMIT"
       if [ $? -ne 0 ]; then
         echo "Ошибка при реверте коммита $COMMIT"
         exit 1
       fi
     done
   fi

   # Пушим изменения
   git push origin "$BRANCH_NAME"

   # Создаём PR
   gh pr create --base main --head "$BRANCH_NAME" --title "Revert PR #$INPUT" --body "Automated revert of PR #$INPUT or commit $INPUT" --repo "$REPO"

   echo "PR для реверта создан: $BRANCH_NAME"
   ```

2. Сделайте скрипт исполняемым:
   ```bash
   chmod +x revert_pr.sh
   ```

3. Настройте переменную окружения `GITHUB_TOKEN`:
   ```bash
   export GITHUB_TOKEN=<your-token>
   ```

4. Укажите правильное имя репозитория в переменной `REPO` внутри скрипта.

## Использование

Скрипт принимает один аргумент: хэш мерж-коммита или номер PR.

### Синтаксис
```bash
./revert_pr.sh <merge-commit-hash-or-pr-number>
```

### Шаги выполнения
1. Скрипт проверяет, является ли аргумент хэшем коммита или номером PR.
2. Создаёт новую ветку с уникальным именем (`revert-pr-<input>-<timestamp>`).
3. Выполняет реверт:
   - Для мерж-коммита: `git revert -m 1 <commit-hash>`.
   - Для PR: ревертит все коммиты PR в обратном порядке.
4. Пушит изменения в новую ветку.
5. Создаёт пулл-реквест в основную ветку (`main`) с помощью `gh`.

### Примеры

#### Пример 1: Реверт мерж-коммита
Если PR был вмержен с созданием мерж-коммита, используйте его хэш:
```bash
./revert_pr.sh abc123def456
```
- Скрипт создаст ветку, например, `revert-pr-abc123def456-1697051234`.
- Выполнит `git revert -m 1 abc123def456`.
- Создаст PR с заголовком "Revert PR #abc123def456" и описанием.

#### Пример 2: Реверт всех коммитов PR
Если нужно ревертировать все коммиты из PR #123:
```bash
./revert_pr.sh 123
```
- Скрипт получит список коммитов PR #123.
- Ревертирует их в обратном порядке.
- Создаст ветку, например, `revert-pr-123-1697051234`.
- Создаст PR с заголовком "Revert PR #123".

#### Пример 3: Ошибка при отсутствии аргумента
```bash
./revert_pr.sh
```
Вывод:
```
Ошибка: укажите хэш мерж-коммита или номер PR
```

## Обработка ошибок

- **Отсутствие аргумента**: Скрипт завершает работу с сообщением об ошибке.
- **Недействительный хэш или номер PR**: Если `git rev-parse` или `gh pr view` не находят коммит/PR, скрипт завершится с ошибкой.
- **Конфликты при реверте**: Если возникают конфликты, скрипт завершится с ошибкой. Нужно вручную разрешить конфликты и завершить реверт (`git revert --continue`).
- **Проблемы с доступом**: Убедитесь, что `GITHUB_TOKEN` имеет права на создание веток и PR.

## Дополнительные рекомендации

- **Автоматический мерж**: Если правила репозитория позволяют, раскомментируйте строку `gh pr merge` в скрипте для автоматического мержа PR после создания. Убедитесь, что ветка `main` не защищена от прямого мержа.
- **Логирование**: Добавьте логирование в файл или систему уведомлений (например, Slack) для отслеживания выполнения.
- **Тестирование**: Протестируйте скрипт на тестовом репозитории, чтобы избежать ошибок в продакшене.
- **Ограничения доступа**: Настройте доступ к выполнению скрипта только для определённых пользователей (например, через CI/CD или проверку прав).

## Ограничения

- Скрипт предполагает, что основная ветка называется `main`. Если используется другая (например, `master`), замените `main` в скрипте.
- Конфликты реверта требуют ручного вмешательства.
- Скрипт работает только с GitHub (из-за использования `gh`). Для других платформ (GitLab, Bitbucket) нужно адаптировать команды для создания PR.

## Расширения

Для интеграции с CI/CD (например, GitHub Actions) можно создать пайплайн, который запускает скрипт на основе комментария в PR (например, `/revert 123`). Пример такого пайплайна доступен по запросу.

